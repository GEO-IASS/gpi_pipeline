
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Primitives &mdash; GPI Data Pipeline 1.3.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc_gpi.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="GPI Data Pipeline 1.3.0 documentation" href="../index.html" />
    <link rel="up" title="GPI Data Pipeline Developer’s Guide" href="index.html" />
    <link rel="next" title="GPItv Development" href="gpitv_devel.html" />
    <link rel="prev" title="Utility Functions" href="utilities.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="gpitv_devel.html" title="GPItv Development"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="utilities.html" title="Utility Functions"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">GPI Data Pipeline 1.3.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">GPI Data Pipeline Developer&#8217;s Guide</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/GPI_Logo_v2012.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Primitives</a><ul>
<li><a class="reference internal" href="#adding-new-primitives">Adding New Primitives</a><ul>
<li><a class="reference internal" href="#creating-a-new-primitive">Creating a new primitive</a></li>
<li><a class="reference internal" href="#updating-the-primitives-index">Updating the primitives index</a></li>
<li><a class="reference internal" href="#useful-backbone-function-calls">Useful backbone function calls</a></li>
<li><a class="reference internal" href="#combining-multiple-files-using-the-special-primitive-accumulate-images">Combining multiple files, using the special primitive &#8216;Accumulate Images&#8217;</a></li>
</ul>
</li>
<li><a class="reference internal" href="#indicating-progress-for-long-running-primitives">Indicating Progress for Long-Running Primitives</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="utilities.html"
                        title="previous chapter">Utility Functions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="gpitv_devel.html"
                        title="next chapter">GPItv Development</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/developers/new_primitives.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="primitives">
<h1>Primitives<a class="headerlink" href="#primitives" title="Permalink to this headline">¶</a></h1>
<div class="section" id="adding-new-primitives">
<h2>Adding New Primitives<a class="headerlink" href="#adding-new-primitives" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">gpi_pipeline_primitives.xml</span></tt> file in the <tt class="docutils literal"><span class="pre">pipeline/config</span></tt> directory contains
an index list to all available primitives of data processing. This provides the
translation between human-friendly primitive descriptions (&#8220;Assemble Spectral
Datacube&#8221;) and IDL function names (<tt class="docutils literal"><span class="pre">extractcube</span></tt>), and lists the available
parameters for each primitive. To add a new primitive to the pipeline, you need
to</p>
<ul class="simple">
<li>write the actual primitive code, as an IDL function in the pipeline/primitives directory, and</li>
<li>Update the gpi_pipeline_primitives.xml file to include the information on the new routine.</li>
</ul>
<div class="section" id="creating-a-new-primitive">
<h3>Creating a new primitive<a class="headerlink" href="#creating-a-new-primitive" title="Permalink to this headline">¶</a></h3>
<p>The best course of action for creating a new module is to use an existing one
as a template.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>There is a file <tt class="docutils literal"><span class="pre">__template.pro</span></tt> in the primitives directory for this purpose.
You should make a copy of that and edit it to create any new primitive.</p>
<p class="last">This file includes example code and documentation comments demonstrating
how to do typical tasks such as accessing data and header arrays, retrieving
arguments passed to primitives, and logging output.</p>
</div>
<p>Pay particular attention to the way data is passed in and out
with pointers in the dataset structure, and to the common blocks of code
<tt class="docutils literal"><span class="pre">__start_primitive.pro</span></tt> and <tt class="docutils literal"><span class="pre">__end_primitive.pro</span></tt> that get invoked at the start and
end of each primitive to provide common functionality.</p>
<p>Also note the structured comments in the file header (e.g. &#8220;PIPELINE ORDER:
2.0&#8221; and other comment lines starting with &#8220;PIPELINE&#8221;).
These are what get parsed to create the index file for the primitives, <tt class="docutils literal"><span class="pre">gpi_pipeline_primitives.xml</span></tt>.
You will
need to edit these comments to define what your new primitive is called, what arguments
it takes, in what position in the sequence the GUIs will suggest ordering it,
etc. For instance, to define parameters for your modules, add &#8220;PIPELINE
ARGUMENT&#8221; lines here, most easily by copying the lines from the template and
editing as needed.</p>
<p>All primitives receive three inputs when called: a dataset array containing pointers to the current dataset (loaded FITS files being processed),
a modules list containing the recipe&#8217;s primitives and their arguments in order, and a handle to the pipeline backbone object.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since <tt class="docutils literal"><span class="pre">__start_primitive</span></tt> loads two common blocks (<tt class="docutils literal"><span class="pre">PIP</span></tt> and <tt class="docutils literal"><span class="pre">APP_CONSTANTS</span></tt>) that are defined in the backbone, you will get an error when trying to compile your primitive unless the backbone has already been compiled (<tt class="docutils literal"><span class="pre">.comp</span> <span class="pre">gpipipelinebackbone__define.pro</span></tt>)</p>
</div>
<p><strong>Common arguments</strong>
There are a few generically-handled primitive arguments like &#8216;gpitv&#8217; and &#8216;save&#8217; that you will always
have in a primitive. These are handled either by the __end_primitive code block, or by the pipeline backbone
itself in the case of the &#8216;skip&#8217; keyword.</p>
<blockquote>
<div><ul class="simple">
<li><strong>gpitv</strong>: Send the output image or cube to gpitv</li>
<li><strong>save</strong>: If set to true (1), save the image or cube to disk</li>
<li><strong>stopidl</strong>: If present and set to true, after the primitive is complete IDL will stop at the command line
debugger for testing purposes. (This only works if you are running from source, not the compiled code)</li>
<li><strong>skip</strong>: If present and set to true, the primitive will be skipped entirely. This is useful if you want
to temporarily disable some step without deleting the line entirely from a recipe.</li>
</ul>
</div></blockquote>
<p><strong>File naming convention</strong>
By convention, all primitive filenames should be named starting with &#8220;<tt class="docutils literal"><span class="pre">gpi_</span></tt>&#8221; and the filename should be exactly consistent with the descriptive name chosen for that primitive, but with spaces converted to underscores. That is,
if you have a primitive named &#8220;Write My Paper&#8221;, it should be named <tt class="docutils literal"><span class="pre">gpi_write_my_paper.pro</span></tt>.</p>
<p><strong>Adding to svn</strong>
If/when you are adding your new primitive into the GPI DRP subversion repository, after you have done <tt class="docutils literal"><span class="pre">svn</span> <span class="pre">add</span> <span class="pre">gpi_myfilename.pro</span></tt>, please also do <tt class="docutils literal"><span class="pre">svn</span> <span class="pre">propset</span> <span class="pre">svn:keywords</span> <span class="pre">Id</span> <span class="pre">gpi_myfilename.pro</span></tt>. This sets a subversion metadata flag property so that the Id comment line in the primitive will be updated automatically with every new revision. This is used by the pipeline to write primitive revision numbers into the HISTORY headers.</p>
</div>
<div class="section" id="updating-the-primitives-index">
<h3>Updating the primitives index<a class="headerlink" href="#updating-the-primitives-index" title="Permalink to this headline">¶</a></h3>
<p>The XML index file is generated by runing the <tt class="docutils literal"><span class="pre">make_primitives_config.pro</span></tt>
procedure while in the pipeline directory. This will automatically update the
<tt class="docutils literal"><span class="pre">gpi_pipeline_primitives.xml</span></tt>  based on the supplied header information in all
available modules. You may then restart the DRP and other IFS software to take
advantage of your new modules.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is a button in the pipeline Status Console to &#8220;Rescan DRP
Configuration&#8221;. If you press this, it will automatically run
make_primitives_config, load the new configuration into the DRP, and
recompile all IDL code (assuming you&#8217;re not running in IDL Runtime mode
from a compiled code!). So, if you&#8217;re editing a pipeline routine or
adding a new one, this is the best way to make that updated code
immediately available for execution in a currently-active pipeline session.</p>
</div>
</div>
<div class="section" id="useful-backbone-function-calls">
<h3>Useful backbone function calls<a class="headerlink" href="#useful-backbone-function-calls" title="Permalink to this headline">¶</a></h3>
<p>The pipeline backbone provides some useful function calls for use in primitives.
See the <tt class="docutils literal"><span class="pre">__template.pro</span></tt> file for more example code.</p>
<p>Add some message to the pipeline log: This will be displayed on screen and written to the
log file:</p>
<div class="highlight-python"><div class="highlight"><pre>backbone-&gt;Log, &quot;        Combining datacube using method=&quot;+method
</pre></div>
</div>
<p>Add a keyword value to a header. This will automatically be added to either the Primary or Extension
HDU as appropriate, in accordance with the keyword lists defined in the GPI-to-Gemini software ICD.</p>
<div class="highlight-python"><div class="highlight"><pre>backbone-&gt;set_keyword,&#39;DRPDARK&#39;,dark_filename
</pre></div>
</div>
<p>The same function call works to write HISTORY keywords as well:</p>
<div class="highlight-python"><div class="highlight"><pre>backbone-&gt;set_keyword,&#39;HISTORY&#39;,functionname+&quot;: loaded file &quot;+c_File
</pre></div>
</div>
</div>
<div class="section" id="combining-multiple-files-using-the-special-primitive-accumulate-images">
<h3>Combining multiple files, using the special primitive &#8216;Accumulate Images&#8217;<a class="headerlink" href="#combining-multiple-files-using-the-special-primitive-accumulate-images" title="Permalink to this headline">¶</a></h3>
<p>As discussed elsewhere, the primitive &#8220;Accumulate Images&#8221; is used to gather multiple files together and then combine them.
These are stored using either disk files or arrays in memory. To access the saved files, use the accumulate_getimage function call.</p>
<p>Here is some example code, basically a simplified version derived from the Combine 2D Images primitive:</p>
</div>
</div>
<div class="section" id="indicating-progress-for-long-running-primitives">
<h2>Indicating Progress for Long-Running Primitives<a class="headerlink" href="#indicating-progress-for-long-running-primitives" title="Permalink to this headline">¶</a></h2>
<p>When running in GUI mode, the pipeline provides progress indications via two statusbars in the status console - &#8216;Current Recipe Completion Status&#8217; and &#8216;Current FITS File Completion Status&#8217;.  These are updated directly by function <tt class="docutils literal"><span class="pre">gpistatusconsole::set_percent</span></tt>, which is usually called by <tt class="docutils literal"><span class="pre">gpistatsuconsole::update</span></tt>.  <tt class="docutils literal"><span class="pre">gpistatusconsole::set_percent</span></tt> takes two arguments (percent values for the two statusbars between 0 and 100), either of which is ignored when set to -1, and an optional <tt class="docutils literal"><span class="pre">/append</span></tt> flag, which causes the input values to be added to the current percentages rather than overwriting them.  <tt class="docutils literal"><span class="pre">gpistatusconsolve::update</span></tt> sets the two percentages as:</p>
<div class="highlight-python"><div class="highlight"><pre>100d*(double(filenum) + double(indexModules)/double(N_ELEMENTS(Modules)))/double(nbtotfile)
and
100d*double(indexModules)/double(N_ELEMENTS(Modules))
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">filenum</span></tt> is the index of the FITS file currently being processed, <tt class="docutils literal"><span class="pre">nbtotfile</span></tt> is the total number of files in the current recipe, and <tt class="docutils literal"><span class="pre">indexModules</span></tt> is the index of the module currently being run.  <tt class="docutils literal"><span class="pre">gpistatusconsolve::update</span></tt> is called from <tt class="docutils literal"><span class="pre">gpiPipelineBackbone::Reduce</span></tt> before every call to <tt class="docutils literal"><span class="pre">gpiPipelineBackbone::RunModule</span></tt>, so that the statusbars get updated between executions of separate primitives.</p>
<p>Occasionally, a primitive will have a sufficiently long execution time that it makes sense to update the statsubars while it is executing to indicate to the user that the pipeline has not stalled or silently crashed.  This works particularly well in primitives that execute long-running, fixed-size loops.</p>
<p>The status console object can be retrieved from within the primitive scope as:</p>
<div class="highlight-python"><div class="highlight"><pre>statuswindow = backbone-&gt;getstatusconsole()
</pre></div>
</div>
<p>You can then update the FITS File Completion status bar from within the primitive&#8217;s main loop as:</p>
<div class="highlight-python"><div class="highlight"><pre>FOR loopvar = 0,numIterations-1 DO BEGIN
    ...
    statuswindow-&gt;set_percent,-1,1d/numIterations*100d/double(N_ELEMENTS(Modules)),/append
ENDFOR
</pre></div>
</div>
<p>This has the effect of incrementally filling in the FITS File Completion status bar while the primitive is executing, while leaving the Recipe Completion status bar static.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If your primitive contains multiple separate loops, you can add multiple calls to update the status bars, but it is up to you to figure out the proper values for incrementing.  If you increment the progress on either bar to greater than 100%, no error will occur, but the status bars will be completely filled and will appear static to the user.  For an example of this kind of multiple loop implementation, see the Wavelength Solution primitive.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="gpitv_devel.html" title="GPItv Development"
             >next</a> |</li>
        <li class="right" >
          <a href="utilities.html" title="Utility Functions"
             >previous</a> |</li>
        <li><a href="../index.html">GPI Data Pipeline 1.3.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >GPI Data Pipeline Developer&#8217;s Guide</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2008-2014, Marshall Perrin, Jerome Maire &amp; the GPI Data Analysis Team.
      Last updated on Jun 18, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>